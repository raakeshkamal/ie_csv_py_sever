# InvestEngine CSV Server

A Python web server for uploading batches of trading statement CSV files (e.g., GIA and ISA accounts), merging them into a unified SQLite database with an added `Account_Type` column and `Ticker` enrichment. The upload endpoint handles merging and saving to DB, while a separate endpoint computes and returns data for interactive graphs: a histogram of monthly net contributions (buys positive, sells negative) and a line graph of actual portfolio value over time (including asset price changes via historical prices from yfinance). Each new upload overwrites the previous merged data to keep only the latest batch. Graphs are embedded directly in the page after upload and chart generation (no download needed). Tickers are extracted in the background using Yahoo Finance API searches.

## Features
- Web interface for batch file uploads using FastAPI and HTMX
- Automatic parsing and merging of trading statement CSVs using Pandas
- CSV preprocessing: skips title rows, cleans currency formatting (£ and commas), parses dates, and standardizes columns
- Stores merged data in a SQLite database (`db/merged_trading.db`) that overwrites on each new upload
- Ticker extraction using Yahoo Finance search API with ISIN lookup (preferring LSE/.L tickers when available)
- Multi-currency price conversion with FX rate handling (GBp, USD, EUR) to ensure consistent GBP valuations
- Caching system for historical prices and FX rates to optimize performance and reduce API calls
- Parallel processing of ticker lookups and price fetching for improved performance
- Separate endpoints: `/upload/` for data processing and storage, `/portfolio-values/` for portfolio calculations
- Portfolio value calculation that simulates daily holdings and forward-fills for non-trade days
- Interactive Plotly charts for monthly net contributions and portfolio value over time
- Uses UV for dependency management, Jinja2 for templating, and HTMX for dynamic web interactions

## Project Structure
```
.
├── .gitignore                     # Git ignore rules (excludes venv, __pycache__, *.db, trading_statements/)
├── pyproject.toml                 # Dependencies managed by UV
├── uv.lock                        # UV lockfile (auto-generated)
├── README.md                      # This file
├── .vscode/
│   └── settings.json             # VSCode settings with Ruff linting/formatting
├── src/
│   ├── __init__.py               # Package init
│   ├── main.py                   # FastAPI application with upload and portfolio-value endpoints
│   ├── merge_csv.py              # CSV parsing and merging logic
│   ├── temp-tests/               # Testing and development utilities
│   │   ├── extract_tickers.py    # Standalone ticker extraction script for existing DB
│   │   ├── test_merge.py         # Test script for merging sample CSVs
│   │   ├── get_historical_data.py # Utility to fetch historical yfinance data
│   │   └── test_price_factors.py # Price comparison and factor detection tool
│   └── templates/
│       └── upload.html           # Upload form with HTMX and Plotly integration
├── tests/                        # Comprehensive test suite (see tests/README.md)
│   ├── conftest.py               # Pytest fixtures and test configuration
│   ├── test_merge_csv.py         # Unit tests for CSV merging
│   ├── test_tickers.py           # Unit tests for ticker extraction
│   ├── test_portfolio.py         # Unit tests for portfolio calculations
│   └── test_integration.py       # Integration tests for FastAPI endpoints
├── htmlcov/                      # Coverage reports (auto-generated by pytest)
├── db/                           # Database directory (auto-created on first run)
│   └── merged_trading.db         # SQLite database with trades and prices tables
└── trading_statements/           # Sample CSV files (not committed, add your own)
    ├── GIA_Trading_statement_*.csv
    └── ISA_Trading_statement_*.csv
```

## Setup Instructions

1. **Install UV** (if not already installed):
   ```
   curl -LsSf https://astral.sh/uv/install.sh | sh
   ```
   Or via Homebrew: `brew install uv`.

2. **Sync Dependencies**:
   Run this in the project root to install dependencies from `pyproject.toml`:
   ```
   uv sync
   ```

3. **Run the Server**:
   ```
   uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
   ```
   - `--reload` enables auto-reload for development.
   - Access the app at `http://localhost:8000`.

## Usage
1. Open `http://localhost:8000` in your browser to see the upload form.
2. Select multiple CSV files (e.g., `GIA_Trading_statement_*.csv`, `ISA_Trading_statement_*.csv`) using the "Browse Files" button.
3. The form submits automatically on file selection. The server will:
   - Parse each file (skip first row title, use second as header, add `Account_Type` based on filename like 'GIA' or 'ISA').
   - Merge into `db/merged_trading.db` (overwriting any existing data).
   - Extract tickers in the background for unique securities (adds `Ticker` column; may take a few seconds).
   - Display a success message with total transactions and date range, plus a "Generate Charts" button.
4. Click "Generate Charts" to compute and display interactive graphs: histogram of net monthly contributions and line graph of actual portfolio value over time (including price changes).
5. Upload another batch to regenerate the database; click "Generate Charts" to update graphs.

## Running Tests

The project includes a comprehensive test suite. See `tests/README.md` for detailed test documentation.

### Quick Test Commands

```bash
# Install test dependencies
uv sync --extra test

# Run all tests with coverage
pytest

# Run unit tests only
pytest -m unit

# Run integration tests only
pytest -m integration

# Skip slow tests that require network
pytest -m "not slow"

# View detailed coverage report
pytest --cov=src --cov-report=term-missing
```

### Test Categories

- **Unit Tests**: Test CSV parsing, ticker extraction, and portfolio calculation logic in isolation
- **Integration Tests**: Test FastAPI endpoints and full workflow from upload to chart generation
- **Slow Tests**: Tests that call real external APIs (yfinance, network requests)

See `tests/README.md` for comprehensive testing documentation including fixtures, mocking strategies, and CI/CD integration.

## Test Utilities (src/temp-tests/)

The project includes several utility scripts in the `src/temp-tests/` directory for testing and development:

**test_merge.py**
```bash
uv run python src/temp-tests/test_merge.py
```
Test merging sample CSV files without web interface. Merges GIA and ISA files from `trading_statements/` and tests portfolio values endpoint.

**extract_tickers.py**
```bash
uv run python src/temp-tests/extract_tickers.py
```
Run ticker extraction standalone. Useful for reprocessing tickers without re-uploading CSV files.

**get_historical_data.py**
```bash
uv run python src/temp-tests/get_historical_data.py
```
Fetch and display historical price data for a specific ticker. Helpful for debugging price issues or checking data availability. Default ticker: CSH2.L

**test_price_factors.py**
```bash
uv run python src/temp-tests/test_price_factors.py
```
Advanced analysis tool that compares CSV prices to yfinance prices for the same dates to detect constant multiplication factors (useful for identifying unit discrepancies like pence vs pounds). Also tests FX conversion logic.

## CSV Format Assumptions
- Row 1: Title (ignored)
- Row 2: Headers with these expected columns:
  - `Security / ISIN`
  - `Transaction Type`
  - `Quantity`
  - `Share Price`
  - `Total Trade Value`
  - `Trade Date/Time`
  - `Settlement Date`
  - `Broker`
- Data rows: Transaction records
- Currency formatting: Fields with '£' symbols and commas are automatically cleaned to float values
- Date formats: `dd/mm/yy HH:MM:SS` (preferred) or `dd/mm/yy` (fallback)
- Account type detection: Extracted from filename (e.g., 'GIA_' → 'GIA', 'ISA_' → 'ISA') with fallback text search
- Security / ISIN format example: `"Vanguard FTSE Developed World UCITS ETF / ISIN GB00B3XXRP09"` (regex parses name and ISIN for ticker lookup)

## Graphs Explanation
- **Monthly Net Contributions Histogram**: Bars show net cash flow per month (positive for buys/investments, negative for sells/withdrawals). Combines GIA and ISA data for a holistic view of contributions/distributions.
- **Actual Portfolio Value Line Graph**: Daily portfolio value over time based on simulated holdings from trades multiplied by historical closing prices from yfinance. The calculation:
  - Simulates holdings cumulatively (buys increase shares, sells decrease them)
  - Forward-fills holdings for non-trade days
  - Fetches and converts all historical prices to GBP using proper currency conversions
  - Applies FX rates for non-GBP securities (historic rates cached to avoid refetching)
  - Calculates daily value as Σ(holdings × price) across all tickers
  - Aggregates across all account types; invalid tickers contribute 0 value
- Charts are interactive (zoom, hover) via Plotly and rendered client-side from server-computed data

## Ticker Extraction
- **Extraction Process**: For each unique "Security / ISIN", the system:
  - Parses security name and ISIN using regex
  - Searches Yahoo Finance API by security name (primary method)
  - Prefers LSE exchange or .L suffix tickers, with ETF/Equity quote types
  - Falls back to ISIN-based search if name search yields no results
  - Stores results in database `Ticker` column (e.g., "VUSA.L" or "Not found")
- **Price Caching**: The system maintains two tables in SQLite:
  - `trades`: Merged transaction data with ticker mappings
  - `prices`: Historical prices and FX rates indexed by ticker and date to avoid refetching
- **Multi-Currency Handling**:
  - Detects currency for each ticker (GBP, GBp, USD, EUR, etc.)
  - Converts GBp prices (pence) to GBP by dividing by 100
  - Fetches appropriate FX rates for non-GBP securities (GBPUSD=X, EURGBP=X)
  - Caches FX rates to optimize performance
- Note: Yahoo Finance API may rate-limit requests; extraction happens synchronously during upload to ensure tickers are available for charts

## Development Notes

### Architecture & Performance

**Parallel Processing**: The system employs concurrent operations for optimal performance:
- Ticker lookups and currency detection run in parallel using `ThreadPoolExecutor` (5 workers default)
- Price fetching and currency conversion are parallelized for all unique securities
- FX rate fetching happens asynchronously for all needed currencies

**Caching System**: Optimized to reduce external API calls:
- Historical prices cached in SQLite `prices` table by (ticker, date) with OR REPLACE semantics
- FX rates (GBPUSD=X, EURGBP=X) cached using the same mechanism
- Cache hit query: Checks database before calling yfinance API
- Automatic forward-fill of cached data to handle weekends/holidays

**Database Schema**:
- `trades` table: Merged CSV data with columns including `Account_Type` and `Ticker`
- `prices` table: Historical prices and FX rates with primary key on (ticker, date)

### Development Workflow

- **Live Reload**: Edit code in `src/` and restart/reload as needed (FastAPI's `--reload` flag recommended for development)
- **Linting/Formatting**: Ruff is configured for linting/formatting in `.vscode/settings.json` (runs on save)
- **Database**: SQLite database is overwritten on each upload (no versioning)
- **Price Fetching**: yfinance fetches historical 'Close' prices; handles missing data with forward-fill
- **Error Handling**: Invalid CSVs or API errors return JSON error messages displayed in the browser
- **Logging**: Comprehensive logging to console for merging, computations, ticker searches, and price conversions

**Test Scripts**: Utility scripts in `src/temp-tests/` for debugging and development. See the "Test Utilities" section for detailed instructions:
- `test_merge.py`: Test merging without the web interface
- `extract_tickers.py`: Run ticker extraction standalone on existing DB
- `get_historical_data.py`: Fetch and inspect historical yfinance data
- `test_price_factors.py`: Analyze price ratios between CSV and yfinance data

### Production Considerations

- Remove `--reload` flag
- Use Gunicorn or similar production server
- Implement HTTPS
- Consider Redis or similar for distributed caching in multi-server setups
- Monitor Yahoo Finance API rate limits (consider request throttling)
- Add authentication/authorization for upload endpoint
- Implement database backups if historical data preservation is needed

## Troubleshooting

**Dependency Issues**
- If dependencies fail to install: Run `uv sync --dev` or check `pyproject.toml` for version conflicts
- Ensure Python 3.8+ is installed and UV is available in PATH

**Server Problems**
- Server not starting: Check for port 8000 conflicts, verify UV installation
- Use `uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000` for detailed error output

**CSV Upload Issues**
- CSV issues: Ensure files match expected format (see CSV Format Assumptions)
- Invalid columns or malformed dates will raise errors displayed in the browser
- Check browser console for JavaScript errors related to file handling

**Ticker & Price Issues**
- Ticker extraction fails: Check internet connection; Yahoo Finance API may rate-limit
- Run `uv run python src/tests/extract_tickers.py` manually to debug ticker extraction
- No graphs appearing: Ensure ticker extraction completed (happens synchronously during upload)
- Verify yfinance can fetch data (check internet connectivity, ticker symbols are valid)

**Database & Caching**
- Database not created: Upload files first; `db/` directory auto-creates
- Old data persisting: Remember database overwrites on each upload (this is by design)
- Price caching: Check `prices` table in SQLite DB to verify caching is working

**Chart Generation**
- Charts not displaying: Check browser console for JavaScript errors; verify Plotly CDN loaded
- Empty chart data: Verify ticker extraction found valid tickers; check console logs for errors
- Mismatched data lengths: Check server logs; may indicate data validation issues

**Visual Studio Code**
- Linter errors: Ruff/Basedpyright may flag type issues in dynamic code; these don't affect runtime
- Ensure Ruff extension is installed and enabled
- Format on save is configured in `.vscode/settings.json`

**Performance**
- Slow ticker extraction: Normal for many securities due to Yahoo Finance API rate limiting
- Slow chart generation: First run fetches all historical data; subsequent runs use cache
- Consider running ticker extraction during off-hours for large portfolios